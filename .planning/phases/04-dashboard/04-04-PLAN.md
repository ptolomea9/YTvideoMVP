---
phase: 04-dashboard
plan: 04
type: execute
---

<objective>
Add media kit download functionality allowing agents to download branded and unbranded video versions.

Purpose: Give agents easy access to both branded (social media) and unbranded (MLS-compliant) versions of their videos.
Output: Download button in VideoPlayerDialog, API endpoint for secure download, media kit modal for choosing version.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies
@.planning/phases/04-dashboard/04-01-PLAN.md
@.planning/phases/04-dashboard/04-02-PLAN.md
@.planning/phases/04-dashboard/04-03-PLAN.md

# Existing codebase
@src/components/dashboard/VideoPlayerDialog.tsx
@src/components/dashboard/VideoCard.tsx
@src/types/video.ts
@supabase/migrations/001_initial_schema.sql

**Tech stack available:**
- Next.js API routes
- Supabase for auth/RLS
- Videos stored with branded_url and unbranded_url (S3/json2video URLs)

**Video URLs:**
- branded_url: Video with agent branding (for social media)
- unbranded_url: Clean version (for MLS compliance)
- Both are direct MP4 URLs from json2video rendering

**Design decision:**
Direct download via browser (no server proxy needed) since URLs are already accessible.
API endpoint validates ownership before returning download URLs.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create download API endpoint</name>
  <files>src/app/api/videos/[id]/download/route.ts</files>
  <action>
Create API endpoint that returns download URLs after validating ownership:

1. GET /api/videos/[id]/download
   - Authenticate user from session
   - Verify video belongs to user (RLS handles this via Supabase query)
   - Return JSON with both URLs and suggested filenames

2. Response format:
   ```typescript
   {
     branded: {
       url: string;
       filename: string; // e.g., "123-main-st-branded.mp4"
     };
     unbranded: {
       url: string | null; // null if mls_dual_output was false
       filename: string;
     };
   }
   ```

3. Generate descriptive filenames from listing address:
   - Sanitize address (remove special chars, spaces to dashes)
   - Add suffix: -branded.mp4 or -unbranded.mp4

4. Error handling:
   - 401 if not authenticated
   - 404 if video not found or not owned by user
   - 400 if video not completed (no URLs available)
  </action>
  <verify>curl /api/videos/[id]/download with auth returns download URLs</verify>
  <done>API endpoint returns download URLs with ownership validation and descriptive filenames</done>
</task>

<task type="auto">
  <name>Task 2: Create MediaKitDialog component</name>
  <files>src/components/dashboard/MediaKitDialog.tsx</files>
  <action>
Create a dialog for downloading media kit (branded/unbranded options):

1. Props:
   - videoId: string
   - address: string (for display)
   - open: boolean
   - onOpenChange: (open: boolean) => void

2. Dialog content:
   - Title: "Download Media Kit"
   - Subtitle: Property address
   - Two download cards side by side:
     a. Branded Version:
        - Icon: social media icon (Share2 or similar)
        - "For Social Media"
        - Download button
     b. Unbranded Version:
        - Icon: building/home icon
        - "MLS Compliant"
        - Download button (disabled if not available)
   - "Download Both" button at bottom

3. Download logic:
   - Fetch from /api/videos/[id]/download
   - Use browser download: create anchor with download attribute
   - Show loading state during fetch
   - Show success toast on download start

4. Styling:
   - Dark theme matching app
   - Gold accent on primary download button
   - Cards with hover states
  </action>
  <verify>Open media kit dialog → click download → file downloads with correct filename</verify>
  <done>MediaKitDialog shows download options, triggers browser downloads with descriptive filenames</done>
</task>

<task type="auto">
  <name>Task 3: Add download button to VideoPlayerDialog and VideoCard</name>
  <files>src/components/dashboard/VideoPlayerDialog.tsx, src/components/dashboard/VideoCard.tsx</files>
  <action>
Wire up MediaKitDialog to video player and cards:

1. VideoPlayerDialog updates:
   - Add "Download" button in header (next to close button)
   - Button opens MediaKitDialog
   - Add state for mediaKitOpen
   - Render MediaKitDialog with video info

2. VideoCard updates (optional quick action):
   - Add download icon button in bottom-right corner (only for completed videos)
   - Click opens MediaKitDialog directly (without opening video player first)
   - Use Lucide Download icon

3. Both entry points:
   - VideoCard download icon → MediaKitDialog
   - VideoPlayerDialog download button → MediaKitDialog

4. Icon styling:
   - Semi-transparent background
   - Hover highlight
   - Only visible on completed videos
  </action>
  <verify>Download button in video player opens media kit dialog. Download icon on card also works.</verify>
  <done>Download accessible from both video player dialog and video card quick action</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete video gallery with hover autoplay, full player, realtime progress, and media kit download</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/dashboard
    3. If no videos exist:
       - Go to /create and submit a video
       - Return to dashboard
    4. Test video card features:
       - Hover over completed video → should autoplay muted
       - Click completed video → full player dialog opens
       - Click download button → media kit dialog shows both options
       - Click download → file downloads with property address filename
    5. Test progress states:
       - If a video is processing, verify progress overlay shows
       - If any video failed, verify error message displays
    6. Confirm responsive grid:
       - Mobile width → 2 columns
       - Desktop width → 4 columns
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Download API endpoint validates ownership
- [ ] MediaKitDialog shows both download options
- [ ] Downloads trigger with descriptive filenames
- [ ] Download button accessible from player and card
</verification>

<success_criteria>
- Download API endpoint validates ownership and returns URLs
- MediaKitDialog provides clear download options
- Both branded and unbranded downloads work
- Download accessible from multiple entry points
- Phase 4 complete with all dashboard features working
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard/04-04-SUMMARY.md` following summary template.
Mark Phase 4 (Dashboard) as complete.
</output>
