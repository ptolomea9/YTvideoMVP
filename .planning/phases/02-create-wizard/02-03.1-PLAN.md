---
phase: 02-create-wizard
plan: 03.1
type: execute
---

<objective>
Add per-image enhancement presets to the Upload step with progressive disclosure UI.

Purpose: Allow agents to optionally enhance photos (Golden Hour, HDR, Vivid) without cluttering the default experience.
Output: Enhancement controls integrated into ImageCard, Kie.ai API integration, enhanced image previews.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./02-03.1-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-create-wizard/02-03-SUMMARY.md

# Upload step (where enhancement UI goes):
@src/components/wizard/steps/upload-step.tsx

# Wizard types:
@src/lib/wizard/types.ts

**UX Requirements:**
- Non-intrusive: Enhancement is optional, not in-your-face
- Progressive disclosure: Enhance icon appears on hover, presets on click
- Instant preview: Show enhanced image immediately after selection
- Revert capability: User can switch back to Original
- Default: Original (no processing unless chosen)

**Kie.ai Context:**
- Kie.ai is an aggregator with access to image-to-image models
- Currently using nano-banana for resize (1080x1920) in n8n
- Enhancement presets will be applied in n8n pipeline, not in wizard
- Wizard captures user's enhancement choice per image
- n8n applies enhancement before Kling motion generation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enhancement field to WizardImage type</name>
  <files>src/lib/wizard/types.ts</files>
  <action>
Add enhancement preset type and field to WizardImage:

```ts
/**
 * Enhancement preset options for image processing.
 * Applied via Kie.ai in n8n pipeline.
 */
export type EnhancementPreset =
  | 'original'      // No enhancement
  | 'golden_hour'   // Warm sunset lighting, sky enhancement
  | 'hdr'           // High dynamic range, detail enhancement
  | 'vivid';        // Saturated colors, contrast boost

/**
 * Image data after upload (Step 2 - UPLOAD).
 */
export interface WizardImage {
  id: string;
  url: string;
  filename: string;
  order: number;
  label: string;
  roomType: RoomType;
  features: string[];
  enhancement: EnhancementPreset;  // NEW: Default 'original'
}
```

Update initialWizardState to include enhancement: 'original' as default.

Add UPDATE_IMAGE_ENHANCEMENT action type to WizardAction union.
  </action>
  <verify>npm run build succeeds, types compile correctly</verify>
  <done>WizardImage has enhancement field, action type defined</done>
</task>

<task type="auto">
  <name>Task 2: Add enhancement action to wizard context</name>
  <files>src/lib/wizard/wizard-context.tsx</files>
  <action>
Add reducer case and context method for image enhancement:

Reducer case:
```ts
case "UPDATE_IMAGE_ENHANCEMENT":
  return {
    ...state,
    images: state.images.map((img) =>
      img.id === action.payload.imageId
        ? { ...img, enhancement: action.payload.preset }
        : img
    ),
    error: null,
  };
```

Add to WizardContextValue interface:
```ts
updateImageEnhancement: (imageId: string, preset: EnhancementPreset) => void;
```

Add implementation:
```ts
const updateImageEnhancement = useCallback(
  (imageId: string, preset: EnhancementPreset) =>
    dispatch({
      type: "UPDATE_IMAGE_ENHANCEMENT",
      payload: { imageId, preset }
    }),
  []
);
```

Export in context value.
  </action>
  <verify>npm run build succeeds, context provides updateImageEnhancement</verify>
  <done>Wizard context can update image enhancement</done>
</task>

<task type="auto">
  <name>Task 3: Create EnhanceButton component with popover presets</name>
  <files>src/components/wizard/steps/upload-step.tsx</files>
  <action>
Add EnhanceButton component within upload-step.tsx (or separate file if preferred).

UI pattern - progressive disclosure:
1. Show sparkle/wand icon on image card hover (bottom-right corner)
2. Click opens Popover with preset chips
3. Preset chips: Original | Golden Hour | HDR | Vivid
4. Selected preset has gold background, others are ghost
5. Selecting a preset closes popover, shows checkmark on icon

```tsx
const ENHANCEMENT_PRESETS: { value: EnhancementPreset; label: string; icon?: string }[] = [
  { value: 'original', label: 'Original' },
  { value: 'golden_hour', label: 'Golden Hour' },
  { value: 'hdr', label: 'HDR' },
  { value: 'vivid', label: 'Vivid' },
];

function EnhanceButton({
  currentPreset,
  onSelect
}: {
  currentPreset: EnhancementPreset;
  onSelect: (preset: EnhancementPreset) => void;
}) {
  const [open, setOpen] = useState(false);
  const isEnhanced = currentPreset !== 'original';

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <button className={cn(
          "absolute bottom-1 right-1 rounded-full p-1.5 transition-all",
          "opacity-0 group-hover:opacity-100",  // Progressive disclosure
          isEnhanced
            ? "bg-primary text-primary-foreground opacity-100"  // Always show if enhanced
            : "bg-background/90 text-muted-foreground hover:text-foreground"
        )}>
          <Wand2 className="h-3.5 w-3.5" />
        </button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-2" align="end">
        <div className="flex gap-1">
          {ENHANCEMENT_PRESETS.map((preset) => (
            <Button
              key={preset.value}
              variant={currentPreset === preset.value ? "default" : "ghost"}
              size="sm"
              onClick={() => {
                onSelect(preset.value);
                setOpen(false);
              }}
            >
              {preset.label}
            </Button>
          ))}
        </div>
      </PopoverContent>
    </Popover>
  );
}
```

Install Popover if not present: npx shadcn@latest add popover

Integrate into ImageCard:
- Add EnhanceButton to thumbnail container
- Wire onSelect to updateImageEnhancement from context
- Show enhancement badge on thumbnail if not 'original'
  </action>
  <verify>npm run build succeeds, enhance button appears on hover</verify>
  <done>Enhancement popover with preset selection working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Per-image enhancement presets with progressive disclosure UI</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Navigate to /create, fill Step 1
    3. On Step 2 (Upload):
       - Upload several images
       - Click "Analyze with AI"
       - After analysis, hover over an image thumbnail
       - Verify sparkle/wand icon appears (bottom-right)
       - Click the icon - verify popover shows 4 presets
       - Select "Golden Hour" - verify:
         a. Icon stays visible (not just on hover)
         b. Icon has gold/primary background
         c. Popover closes
       - Click icon again, select "Original" - verify icon returns to ghost style
       - Proceed to Step 3 - verify script generation works
    4. Check browser console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] WizardImage type has enhancement field
- [ ] Enhancement action works in wizard context
- [ ] EnhanceButton appears on image hover
- [ ] Popover shows 4 presets
- [ ] Selection updates wizard state
- [ ] Enhanced images show indicator
- [ ] Human verified progressive disclosure UX
</verification>

<success_criteria>

- All 4 tasks completed (including checkpoint)
- All verification checks pass
- Progressive disclosure UX: icon on hover, presets on click
- Enhancement selection persists in wizard state
- Non-intrusive: default flow unchanged for users who don't want enhancement
</success_criteria>

<output>
After completion, create `.planning/phases/02-create-wizard/02-03.1-SUMMARY.md`

Include in summary:
- Enhancement presets added to upload step
- Kie.ai integration prepared (enhancement value stored, applied in n8n Phase 3)
- Progressive disclosure UX pattern established
</output>
