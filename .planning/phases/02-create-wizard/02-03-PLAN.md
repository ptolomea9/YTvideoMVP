---
phase: 02-create-wizard
plan: 03
type: execute
---

<objective>
Build Step 2: image upload with drag-and-drop and GPT-4o Vision smart sorting into room categories.

Purpose: Allow agents to upload property photos that get auto-sorted for the video sequence.
Output: Image upload component with GPT-4o Vision classification into Exterior, Entry, Living, Bedroom, Bathroom, Yard categories.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./02-03-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-create-wizard/02-01-SUMMARY.md
@.planning/phases/02-create-wizard/02-02-SUMMARY.md

# Wizard types:
@src/lib/wizard/types.ts

**Tech decisions:**
- Images stored in Supabase Storage (bucket: listing-images)
- GPT-4o Vision for classification (requires OPENAI_API_KEY)
- Client uploads to Supabase, then API route classifies
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image upload component</name>
  <files>src/components/wizard/steps/upload-step.tsx, src/components/ui/dropzone.tsx</files>
  <action>
Create UploadStep with drag-and-drop image uploader:

Dropzone component:
- Drag-and-drop area with dashed border
- Click to open file picker
- Accept image/* (jpg, png, webp)
- Max 20 images, max 10MB each
- Show upload progress indicator

Preview grid:
- Thumbnail grid of uploaded images
- Remove button on hover
- Show filename and size

For now, store images as local File objects in component state.
Actual upload to Supabase happens when user clicks "Sort Images" button.

Styling: dark theme, gold accent on drag-over, grid layout for previews.
  </action>
  <verify>npm run build succeeds, can drag images onto dropzone</verify>
  <done>Dropzone accepts images, shows previews, supports remove</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase storage upload and GPT-4o Vision sorting</name>
  <files>src/app/api/images/sort/route.ts, src/lib/openai.ts</files>
  <action>
Create image sorting API:

1. Client uploads images to Supabase Storage (listing-images bucket)
2. POST /api/images/sort receives array of image URLs
3. API calls GPT-4o Vision with all images (batch for efficiency)
4. Prompt: "Classify each real estate image into one category: exterior, entry, living, bedroom, bathroom, yard, other. Return JSON array with {url, category} objects."
5. Return sorted images grouped by category

openai.ts:
- Initialize OpenAI client with OPENAI_API_KEY
- Helper function for vision classification

API route:
- Validate image URLs belong to authenticated user
- Call OpenAI Vision API
- Return categorized results

Add OPENAI_API_KEY to .env.example
  </action>
  <verify>API endpoint responds with categorized images</verify>
  <done>Images classified into 6 categories via GPT-4o Vision</done>
</task>

<task type="auto">
  <name>Task 3: Display sorted images by category</name>
  <files>src/components/wizard/steps/upload-step.tsx (extend)</files>
  <action>
Add category display after sorting:

- "Sort Images" button triggers upload + classification
- Loading state with scanning animation (Framer Motion)
- Results displayed in category sections:
  - Exterior (first in video)
  - Entry
  - Living Room
  - Bedroom
  - Bathroom
  - Yard/Outdoor
  - Other (user can reassign)

Each category:
- Collapsible section with image count
- Drag-to-reorder within category (optional, stretch)
- Click image to move to different category (simple dropdown)

Store sorted images in wizard context as: { category: string, url: string, order: number }[]
  </action>
  <verify>Images display grouped by detected category after sorting</verify>
  <done>Sorted images shown in category groups, user can reassign</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Image upload with GPT-4o Vision auto-sorting into room categories</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/create
    3. Complete Step 1 (property data), click Next
    4. On Step 2:
       - Drag multiple property images onto dropzone
       - Verify thumbnails appear with remove buttons
       - Click "Sort Images" button
       - Verify loading animation appears
       - Verify images appear grouped by category (Exterior, Living, etc.)
       - Try moving an image to a different category
    5. Confirm: Images are reasonably categorized (GPT-4o Vision may not be perfect)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Images upload to Supabase Storage
- [ ] GPT-4o Vision API call works (requires valid API key)
- [ ] Images display sorted by category
- [ ] Human verified the sorting UX
</verification>

<success_criteria>

- All 4 tasks completed (including checkpoint)
- All verification checks pass
- Image sorting provides reasonable categorization
- User can override incorrect categorizations
</success_criteria>

<output>
After completion, create `.planning/phases/02-create-wizard/02-03-SUMMARY.md`
</output>
