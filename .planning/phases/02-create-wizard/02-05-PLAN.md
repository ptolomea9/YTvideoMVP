---
phase: 02-create-wizard
plan: 05
type: execute
---

<objective>
Build Step 4: Voice/music selection, MLS toggle, and final submission to create listing and video records.

Purpose: Complete wizard flow with style options and trigger video generation pipeline.
Output: Voice selector, music toggle, MLS dual-output option, and submission that creates database records.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./02-05-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-create-wizard/02-04-SUMMARY.md

# Database schema and Supabase:
@supabase/migrations/001_initial_schema.sql
@src/lib/supabase/server.ts

# Wizard types and state:
@src/lib/wizard/types.ts
@src/lib/wizard/wizard-context.tsx

# Current create page (has StyleStepPlaceholder):
@src/app/(protected)/create/page.tsx

**Note:** This plan creates database records but does NOT trigger n8n.
n8n integration is Phase 3. Video status will be 'pending' until Phase 3.

**Image storage:** Images are currently in wizard state as WizardImage objects with S3 URLs.
We'll store them as JSONB in the listings table (images column).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add images column to listings and create voice config</name>
  <files>supabase/migrations/003_add_listing_images.sql, src/lib/elevenlabs/voices.ts</files>
  <action>
Create migration to add images JSONB column to listings:
- ALTER TABLE listings ADD COLUMN images JSONB DEFAULT '[]'::jsonb;
- This stores the WizardImage array (id, url, filename, order, label, roomType, features)

Create voices.ts with ElevenLabs voice configuration:
```ts
export interface VoiceOption {
  id: string;          // ElevenLabs voice ID
  name: string;        // Display name
  description: string; // Voice personality description
  gender: 'male' | 'female';
  accent: string;      // e.g., 'American', 'British'
}

export const VOICE_OPTIONS: VoiceOption[] = [
  { id: 'pNInz6obpgDQGcFmaJgB', name: 'Adam', description: 'Deep, warm male voice. Professional and trustworthy.', gender: 'male', accent: 'American' },
  { id: '21m00Tcm4TlvDq8ikWAM', name: 'Rachel', description: 'Clear, articulate female voice. Sophisticated and polished.', gender: 'female', accent: 'American' },
  { id: 'AZnzlk1XvdvUeBnXmlld', name: 'Domi', description: 'Confident female voice. Energetic and engaging.', gender: 'female', accent: 'American' },
  { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Bella', description: 'Soft, inviting female voice. Warm and welcoming.', gender: 'female', accent: 'American' },
  { id: 'ErXwobaYiN019PkySvjV', name: 'Antoni', description: 'Smooth male voice. Refined and elegant.', gender: 'male', accent: 'American' },
  { id: 'VR6AewLTigWG4xSOukaG', name: 'Arnold', description: 'Authoritative male voice. Strong and commanding.', gender: 'male', accent: 'American' },
];
```

These are real ElevenLabs voice IDs from their public voice library, suitable for real estate narration.
  </action>
  <verify>Migration file exists with correct SQL, voices.ts exports VOICE_OPTIONS array</verify>
  <done>Images column ready, voice options defined</done>
</task>

<task type="auto">
  <name>Task 2: Create StyleStep component with voice selection and toggles</name>
  <files>src/components/wizard/steps/style-step.tsx, src/components/ui/switch.tsx</files>
  <action>
Install Switch component: npx shadcn@latest add switch

Create StyleStep component:

Voice Selection Section:
- 2-column grid of voice cards
- Each card: name, description, gender/accent badge
- Selected voice has gold border (ring-2 ring-primary)
- Click to select, updates styleOptions.voiceId and voiceName

Toggles Section (Card with toggle rows):
1. Background Music toggle:
   - Label: "Background Music"
   - Description: "Add cinematic background music to your video"
   - Default: on (musicEnabled: true)

2. MLS Dual-Output toggle:
   - Label: "MLS Dual-Output"
   - Description: "Generate both branded and unbranded (MLS-compliant) versions"
   - Default: on (mlsDualOutput: true)
   - Info tooltip: "Unbranded version has no logo/watermark for MLS compliance"

Update StyleOptions type to add:
- musicEnabled: boolean (instead of musicTrack string)
- mlsDualOutput: boolean (new field)

Remove unused fields from StyleOptions: transitionStyle, colorGrading, textOverlay, watermark (not MVP)

Wire up to wizard context via setStyleOptions.
  </action>
  <verify>npm run build succeeds, StyleStep component renders voice cards and toggles</verify>
  <done>Voice selector with 6 options, music and MLS toggles working</done>
</task>

<task type="auto">
  <name>Task 3: Create submission API and integrate StyleStep</name>
  <files>src/app/api/listings/create/route.ts, src/app/(protected)/create/page.tsx</files>
  <action>
Create API POST /api/listings/create:
- Validate user authenticated (getUser from createServerClient)
- Accept: propertyData, images, scriptSections, styleOptions
- Create listing record:
  - user_id, address, city, state, zip, price, bedrooms, bathrooms, sqft
  - property_type (map from wizard propertyType to DB enum)
  - description, neighborhood_pois (features array), images (JSONB)
- Create video record:
  - listing_id, user_id
  - status: 'pending'
  - script_sections: scriptSections JSON
  - voice_id: styleOptions.voiceId
  - music_enabled: styleOptions.musicEnabled
- Return { listingId, videoId }

Update create/page.tsx:
- Import StyleStep, remove StyleStepPlaceholder
- Add styleStepRef with StyleStepHandle
- In handleNext for STYLE step: call submission API
- On success: redirect to /dashboard with sonner toast
- On error: show error toast, keep user on page

Add StyleStepHandle interface to style-step.tsx:
- submit(): Promise<boolean> - validates voice selected, calls API
  </action>
  <verify>npm run build succeeds, submission creates records in Supabase</verify>
  <done>Full submission flow working, redirects to dashboard</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete wizard Step 4 with voice selection, toggles, and submission</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Navigate to /create
    3. Complete Steps 1-3 (property data, images, script)
    4. On Step 4 verify:
       - Voice cards display with names and descriptions
       - Click a voice card - gold border selection
       - Music toggle works (on by default)
       - MLS Dual-Output toggle works (on by default)
    5. Click "Create Video" button
    6. Verify redirect to /dashboard with success toast
    7. Check Supabase tables:
       - listings table: new row with address, images JSONB
       - videos table: new row with status='pending', voice_id, script_sections
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Migration file creates images column
- [ ] Voice selection works (6 options displayed)
- [ ] Music and MLS toggles update wizard state
- [ ] Submission creates listing + video records
- [ ] User redirected to dashboard after submission
- [ ] Human verified complete wizard flow
</verification>

<success_criteria>

- All 4 tasks completed (including checkpoint)
- All verification checks pass
- Complete wizard flow from /create to /dashboard
- Database records match wizard input
- Phase 2: Create Wizard complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-create-wizard/02-05-SUMMARY.md`

Include in summary:
- Phase 2 complete
- Wizard flow ready for n8n integration (Phase 3)
- Videos created with status='pending'
- Images stored in listings.images JSONB column
</output>
