---
phase: 02-create-wizard
plan: 05
type: execute
---

<objective>
Build Step 4: Voice/music selection, MLS toggle, and final submission to create listing and video records.

Purpose: Complete wizard flow with style options and trigger video generation pipeline.
Output: Voice selector, music toggle, MLS dual-output option, and submission that creates database records.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./02-05-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-create-wizard/02-04-SUMMARY.md

# Database schema and Supabase:
@supabase/migrations/001_initial_schema.sql
@src/lib/supabase/server.ts

# Wizard types:
@src/lib/wizard/types.ts

**Note:** This plan creates database records but does NOT trigger n8n.
n8n integration is Phase 3. Video status will be 'pending' until Phase 3.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voice selection component</name>
  <files>src/components/wizard/steps/style-step.tsx, src/lib/elevenlabs/voices.ts</files>
  <action>
Create StyleStep with voice selector:

voices.ts - Define available ElevenLabs voices:
- List of voice objects: { id, name, description, previewUrl, gender, accent }
- Include 4-6 voices suitable for real estate (professional, warm, authoritative)
- Preview URLs from ElevenLabs (public samples)

Voice selector UI:
- Grid of voice cards (2 columns)
- Each card: name, description, play button for preview
- Selected voice has gold border highlight
- Audio preview plays sample clip on click

Store selected voice_id in wizard state styleOptions.
  </action>
  <verify>npm run build succeeds, voice cards render with previews</verify>
  <done>Voice selector shows options with audio preview</done>
</task>

<task type="auto">
  <name>Task 2: Add music and MLS toggles</name>
  <files>src/components/wizard/steps/style-step.tsx (extend), src/components/ui/switch.tsx</files>
  <action>
Add toggle options to StyleStep:

Add shadcn Switch component (npx shadcn@latest add switch).

Toggles section:
1. Background Music: on/off switch
   - Description: "Add cinematic background music to your video"
   - Default: on

2. MLS Dual-Output: on/off switch
   - Description: "Generate both branded (with your logo) and unbranded (MLS-compliant) versions"
   - Default: on
   - Info tooltip explaining MLS requirements

Layout: Card with toggle rows, each with label+description and switch.
Store in wizard state: styleOptions.musicEnabled, styleOptions.mlsDualOutput
  </action>
  <verify>Toggles render and update wizard state</verify>
  <done>Music and MLS toggles functional and styled</done>
</task>

<task type="auto">
  <name>Task 3: Create submission flow and database records</name>
  <files>src/app/api/listings/create/route.ts, src/components/wizard/steps/style-step.tsx (extend)</files>
  <action>
Create submission API and UI:

API POST /api/listings/create:
- Validate user authenticated
- Create listing record from wizard propertyData
- Create video record with:
  - listing_id: new listing ID
  - user_id: authenticated user
  - status: 'pending'
  - script_sections: from wizard state (JSONB)
  - voice_id: selected voice
  - music_enabled: from toggle
- Store image URLs in listing (or separate images table if needed)
- Return { listingId, videoId }

StyleStep submission:
- Review summary showing property address, image count, voice selected
- "Create Video" button (prominent, gold primary)
- Loading state during submission
- On success: redirect to /dashboard with success toast
- On error: show error message, allow retry

Do NOT trigger n8n webhook yet (Phase 3).
  </action>
  <verify>Submission creates listing and video records in database</verify>
  <done>Database records created, user redirected to dashboard</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete wizard Step 4 with voice selection, toggles, and submission</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Complete Steps 1-3 (property, images, script)
    3. On Step 4:
       - Verify voice cards display with names
       - Click a voice card - verify selection highlight
       - Toggle music switch - verify it switches
       - Toggle MLS dual-output - verify it switches
       - Review summary shows property info
       - Click "Create Video"
       - Verify redirect to /dashboard
    4. Check Supabase:
       - Verify listing record created with correct data
       - Verify video record created with status='pending'
       - Verify script_sections JSON matches edited content
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Voice selection works with audio preview
- [ ] Toggles update wizard state
- [ ] Submission creates listing + video records
- [ ] User redirected to dashboard after submission
- [ ] Human verified complete wizard flow
</verification>

<success_criteria>

- All 4 tasks completed (including checkpoint)
- All verification checks pass
- Complete wizard flow from /create to /dashboard
- Database records match wizard input
- Phase 2: Create Wizard complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-create-wizard/02-05-SUMMARY.md`

Include in summary:
- Phase 2 complete
- Wizard flow ready for n8n integration (Phase 3)
- Videos created with status='pending'
</output>
