---
phase: 02-create-wizard
plan: 04
type: execute
---

<objective>
Build Step 3: Script HITL editor with 5 AI-generated tour sections that users can edit.

Purpose: Generate a cohesive narration script grouped by home sections, using image labels/features from step 2.
Output: 5 editable script sections covering the full property tour (MVP-critical HITL feature).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./02-04-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-create-wizard/02-01-SUMMARY.md
@.planning/phases/02-create-wizard/02-02-SUMMARY.md

# Existing wizard implementation:
@src/lib/wizard/types.ts
@src/lib/wizard/wizard-context.tsx
@src/lib/openai.ts
@src/app/(protected)/create/page.tsx
@src/components/wizard/steps/upload-step.tsx

**Key context from prior work:**
- Images have `label` (e.g., "Master Suite with Coffered Ceiling") and `features` array
- Images have `roomType`: exterior, entry, living, kitchen, dining, master_bedroom, bedroom, bathroom, outdoor, other
- PropertyData includes address, specs, description, and neighborhood POIs (features array)

**Design decision - Section-based script editing:**
Group images by roomType into 5 logical tour sections. GPT-4 generates one cohesive narrative that flows from opening to close. Users edit 5 sections (not 20 individual images).

**5 Tour Sections:**
1. **Opening** - Hook + curb appeal (exterior roomType images)
2. **Living Spaces** - Main areas (entry, living, kitchen, dining roomTypes)
3. **Private Retreat** - Bedrooms + baths (master_bedroom, bedroom, bathroom roomTypes)
4. **Outdoor Living** - Backyard + amenities + neighborhood POIs (outdoor roomType)
5. **Closing** - Summary + call-to-action (no images, wraps up the tour)

Each section: ~40-60 words (~12-18 seconds narration). Total: ~60-90 second video.

**MVP-Critical:** If we do the grouping and generation well, users should only need minimal edits.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and create script generation API</name>
  <files>src/lib/wizard/types.ts, src/app/api/script/generate/route.ts</files>
  <action>
**Update ScriptSection type in types.ts:**

Replace imageId-based approach with section-based:
```typescript
export type ScriptSectionType =
  | "opening"      // Exterior/curb appeal
  | "living"       // Entry, living, kitchen, dining
  | "private"      // Bedrooms, bathrooms
  | "outdoor"      // Backyard, amenities, POIs
  | "closing";     // CTA wrap-up

export interface ScriptSection {
  id: string;
  type: ScriptSectionType;
  title: string;           // Display title (e.g., "Opening")
  content: string;         // Narration text
  originalContent: string; // For detecting edits
  imageIds: string[];      // Images referenced in this section
  order: number;
}
```

**Create POST /api/script/generate endpoint:**

Input:
- propertyData: { address, city, state, price, beds, baths, sqft, propertyType, description, features (POIs) }
- images: [{ id, label, features, roomType }]

Processing:
1. Group images by section:
   - opening: roomType === "exterior"
   - living: roomType in ["entry", "living", "kitchen", "dining"]
   - private: roomType in ["master_bedroom", "bedroom", "bathroom"]
   - outdoor: roomType === "outdoor"
   - closing: no images (CTA only)
   - "other" roomType: distribute to most logical section or living as default

2. Build GPT-4 prompt with grouped image context:
   - For each section, list the image labels and features
   - Request cohesive narrative that flows naturally between sections
   - Luxury real estate voice, specific to the property
   - Each section ~40-60 words for ~15s narration
   - Opening: attention-grabbing hook with property type + standout feature
   - Living/Private: reference specific image labels and features naturally
   - Outdoor: weave in neighborhood POIs from propertyData.features
   - Closing: compelling CTA with property address

Output: { sections: ScriptSection[] } with all 5 sections
  </action>
  <verify>API returns 5 sections with cohesive narration referencing image features</verify>
  <done>Script generation groups images by section and produces flowing narrative</done>
</task>

<task type="auto">
  <name>Task 2: Create section-based script editor component</name>
  <files>src/components/wizard/steps/script-step.tsx</files>
  <action>
Create ScriptStep component with 5 editable sections:

Layout:
- Header: "Your Video Script" with total duration estimate
- "Generate Script" button (if no sections yet)
- Loading state with writing animation (Framer Motion typewriter effect)

For each section (5 total):
- Section header with icon + title (Opening, Living Spaces, etc.)
- Thumbnail strip showing images in that section (horizontal scroll if many)
- Editable textarea with script content
- Footer: word count | estimated duration | "Regenerate" button

Section-specific icons:
- Opening: Home icon
- Living Spaces: Sofa icon
- Private Retreat: Bed icon
- Outdoor Living: TreePine icon
- Closing: Sparkles icon

forwardRef pattern:
- Expose validate() method checking all sections have content
- Parent calls ref.validate() before allowing Next

Editing UX:
- Debounced auto-save to wizard context (500ms)
- "Edited" badge when content !== originalContent
- Word count: green (<50), amber (50-70), red (>70)
- Collapsible sections (all expanded by default)

Use UPDATE_SCRIPT action to persist all sections to wizard state.
  </action>
  <verify>npm run build succeeds, 5 sections render with thumbnails</verify>
  <done>Script editor shows 5 collapsible sections with image thumbnails</done>
</task>

<task type="auto">
  <name>Task 3: Integrate script step into wizard flow</name>
  <files>src/app/(protected)/create/page.tsx, src/lib/wizard/wizard-context.tsx</files>
  <action>
**Update wizard-context.tsx:**
- Ensure UPDATE_SCRIPT action replaces entire scriptSections array
- Add UPDATE_SCRIPT_SECTION action for single section regeneration

**Update create/page.tsx:**
Replace ScriptStepPlaceholder with ScriptStep:

- Import ScriptStep and ScriptStepHandle
- Create scriptStepRef using useRef
- Render ScriptStep when currentStep === WizardStep.SCRIPT
- On handleNext for SCRIPT step: validate via scriptStepRef.current.validate()

Auto-generation behavior:
- When entering step 3 with empty scriptSections, auto-trigger generation
- If user goes back to step 2 and modifies images, clear scriptSections (will regenerate on return)
- "Regenerate All" button in ScriptStep header to start fresh

Navigation:
- Back: returns to Upload step (images preserved)
- Next: proceeds to Style step (script persisted)
  </action>
  <verify>Step navigation works, script auto-generates, edits persist</verify>
  <done>Script step integrated with auto-generation and section editing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>5-section script editor with cohesive AI-generated narration</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Complete Steps 1-2:
       - Enter property data with neighborhood POIs
       - Upload 5-10 images, verify labels are set
    3. Click Next to Step 3:
       - Verify loading animation appears
       - Verify 5 sections appear: Opening, Living Spaces, Private Retreat, Outdoor Living, Closing
       - Each section should show thumbnail strip of relevant images
       - Verify script content references specific image labels (e.g., "Gourmet Kitchen")
       - Verify Outdoor section mentions neighborhood POIs
    4. Edit one section:
       - Verify word count updates
       - Verify "Edited" badge appears
       - Navigate back then forward - verify edit persists
    5. Click "Regenerate" on one section:
       - Verify only that section updates
       - Verify other sections unchanged
    6. Confirm: Full script reads as cohesive tour narrative
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Images correctly grouped into 5 sections by roomType
- [ ] Generated script references image labels and features
- [ ] Outdoor section includes neighborhood POIs
- [ ] All 5 sections are editable with word counts
- [ ] Single-section regeneration works
- [ ] Changes persist in wizard state
- [ ] Human verified cohesive narrative quality
</verification>

<success_criteria>

- All 4 tasks completed (including checkpoint)
- All verification checks pass
- Script flows naturally from opening to closing
- Users should need minimal edits if any
- Editing UX is intuitive for non-technical agents
</success_criteria>

<output>
After completion, create `.planning/phases/02-create-wizard/02-04-SUMMARY.md`
</output>
