# Plan: 03-01 Debug Existing n8n Workflow

## Objective

Analyze the existing n8n workflows, understand the payload format they expect, and map the Next.js wizard data to trigger video generation. This plan focuses on understanding the infrastructure before implementing the webhook trigger.

## Context

Three n8n workflows exist:

| Workflow | File | Webhook Path | Purpose |
|----------|------|--------------|---------|
| Video Listing Main | `Video Listing Main WorkFlow.json` | `video-listing` | Full narrated tour with HeyGen avatar |
| Tour Video | `Tour Video.json` | `tour-video` | Simple tour with captions |
| Youtube Video | `Youtube Video.json` | Custom UUID | Full tour with GPT script generation |

The **Tour Video** workflow is the best fit for Phase 3 MVP because:
1. Simpler pipeline (no HeyGen avatar complexity)
2. Uses Kie.ai + Kling 2.6 + json2video (our target stack)
3. Accepts pre-generated script via webhook (matches our HITL editor)

## Workflow Analysis Summary

### Tour Video Webhook Payload (Expected)

```json
{
  "images": [
    { "imageurl": "https://..." }
  ],
  "email": "user@example.com",
  "title": "Property Title",
  "social_handles": "@handle",
  "music": "https://s3-music-url.mp3",
  "voiceId": "elevenlabs-voice-id",
  "price": "500000",
  "city": "Austin",
  "address": "123 Main St",
  "mainSellingPoints": ["Feature 1", "Feature 2"],
  "size": "2500",
  "bedRoomCount": "4",
  "bathRoomCount": "3",
  "propertyType": "Single-Family Home"
}
```

### Our Wizard Output (Current)

```typescript
{
  propertyData: {
    address: string;
    city: string;
    state: string;
    zipCode: string;
    price: string;
    bedrooms: string;
    bathrooms: string;
    squareFeet: string;
    propertyType: string;
    sellingPoints: string[];
    agentPhone?: string;
    agentSocial?: string;
  },
  images: Array<{
    id: string;
    url: string;
    category: string;
    label: string;
    features: string;
    order: number;
    enhancement?: string;
    enhancedUrl?: string;
  }>,
  scriptSections: Array<{
    id: string;
    title: string;
    content: string;
  }>,
  styleOptions: {
    voiceId: string;
    voiceName: string;
    voiceSource: string;
    musicEnabled: boolean;
    mlsDualOutput: boolean;
  }
}
```

## Gap Analysis

| Feature | Workflow Expects | Wizard Provides | Action |
|---------|------------------|-----------------|--------|
| Images | `images[].imageurl` | `images[].url` | Rename field |
| Bedrooms | `bedRoomCount` | `bedrooms` | Rename field |
| Bathrooms | `bathRoomCount` | `bathrooms` | Rename field |
| Size | `size` | `squareFeet` | Rename field |
| Selling points | `mainSellingPoints` | `sellingPoints` | Rename field |
| Social handles | `social_handles` | `agentSocial` | Rename field |
| Script | Not used (GPT generates) | `scriptSections` | Need workflow modification |
| Music URL | `music` (required) | `musicEnabled` (boolean) | Need default music library |
| Email | `email` | Not collected | Add to auth context |
| Title | `title` | Not collected | Generate from address |

## Tasks

### Task 1: Create Payload Transformer Utility

**Files:** `src/lib/n8n/transform.ts`

Create a utility that transforms wizard state into n8n webhook payload format:

```typescript
export interface N8nTourVideoPayload {
  images: Array<{ imageurl: string }>;
  email: string;
  title: string;
  social_handles: string;
  music: string;
  voiceId: string;
  price: string;
  city: string;
  address: string;
  mainSellingPoints: string[];
  size: string;
  bedRoomCount: string;
  bathRoomCount: string;
  propertyType: string;
  webhookResponse?: string[]; // Script sections if workflow supports
  useMusic: 'yes' | 'no';
}

export function transformWizardToN8n(
  propertyData: PropertyData,
  images: WizardImage[],
  scriptSections: ScriptSection[],
  styleOptions: StyleOptions,
  userEmail: string
): N8nTourVideoPayload
```

### Task 2: Add Default Music Library

**Files:** `src/lib/n8n/music.ts`, `.env.example`

Create a music library with default background tracks (stored in S3). The workflow requires a music URL even if music is disabled (it handles muting internally).

```typescript
export const DEFAULT_MUSIC_TRACKS = [
  {
    id: 'elegant-piano',
    name: 'Elegant Piano',
    url: 'https://edgeaireality.s3.eu-north-1.amazonaws.com/music/elegant-piano.mp3',
    mood: 'luxury'
  },
  // Add more tracks
];

export function getDefaultMusicUrl(): string {
  return DEFAULT_MUSIC_TRACKS[0].url;
}
```

### Task 3: Update Submission API

**Files:** `src/app/api/listings/create/route.ts`

Update the submission API to:
1. Get user email from Supabase auth context
2. Generate title from address
3. Transform data to n8n format
4. Store n8n payload in videos table for debugging

```typescript
// Add n8n_payload JSONB column to videos table
// Store transformed payload for debugging
```

### Task 4: Database Migration for n8n Integration

**Files:** `supabase/migrations/004_add_n8n_fields.sql`

Add fields to support n8n integration:

```sql
ALTER TABLE videos ADD COLUMN n8n_payload JSONB;
ALTER TABLE videos ADD COLUMN n8n_execution_id TEXT;
ALTER TABLE videos ADD COLUMN n8n_webhook_url TEXT;
```

### Task 5: Create n8n Webhook Client

**Files:** `src/lib/n8n/client.ts`

Create a client for triggering n8n workflows:

```typescript
const N8N_WEBHOOK_BASE = process.env.N8N_WEBHOOK_URL;

export async function triggerTourVideo(
  payload: N8nTourVideoPayload
): Promise<{ success: boolean; executionId?: string; error?: string }>
```

Note: For this plan, we only build the client structure. Actual webhook triggering will be in 03-02.

---

## Verification

1. **Transform utility tests**: Verify field mapping is correct
2. **Music library**: Verify default URL is accessible
3. **API update**: Submission stores n8n_payload in database
4. **Migration applied**: New columns exist in videos table
5. **Client structure**: n8n client exports correct types

---

## Technical Notes

### n8n Webhook URL

The n8n instance is hosted at `edgeaimedia.app.n8n.cloud`. Webhook URLs follow the pattern:
- Production: `https://edgeaimedia.app.n8n.cloud/webhook/{path}`
- Test: `https://edgeaimedia.app.n8n.cloud/webhook-test/{path}`

### Workflow Selection

For MVP, we'll use the **Tour Video** workflow because:
1. It accepts images + voice + property data
2. It generates captions from property data
3. It's simpler than the main workflow (no avatar)

The main workflow has features we may add later:
- HeyGen avatar generation
- Dual audio track merging
- More complex caption templates

### Script Integration Challenge

The current Tour Video workflow generates its own captions from property data. Our HITL editor generates 5 script sections. Options:
1. Modify workflow to accept `webhookResponse` array (like main workflow)
2. Use main workflow which already accepts script array
3. For MVP, let workflow generate captions; use our script for TTS only

We'll proceed with option 3 for MVP, then enhance in 03-05.

---

## Success Criteria

- [ ] Payload transformer converts wizard data correctly
- [ ] Default music URL is configured
- [ ] Videos table has n8n fields
- [ ] Submission API stores n8n payload
- [ ] n8n client structure ready for 03-02
