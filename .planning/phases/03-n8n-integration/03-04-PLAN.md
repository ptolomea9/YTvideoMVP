---
phase: 03-n8n-integration
plan: 04
type: execute
---

<objective>
Modify the n8n Youtube Video workflow to use wizard-provided script sections instead of generating its own via GPT-4o.

Purpose: The wizard's HITL (Human-in-the-Loop) script editor is MVP-critical. Users edit 5 script sections in Step 3. Currently the n8n workflow ignores `webhookResponse` and generates its own script, wasting the user's edits.

Output: n8n workflow uses `webhookResponse` array for ElevenLabs TTS when provided, falls back to GPT generation when absent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-n8n-integration/03-03-SUMMARY.md
@src/lib/n8n/transform.ts

**Workflow Analysis:**
The Youtube Video workflow (hjG60LIO86i5vxX3) currently:
1. "Prepare Body for GPT To Analyze Images" → Creates GPT payload from property data
2. "Call Open AI To Analyze Images And Generate Script Accordingly" → GPT-4o generates 5-part script
3. "Split the Script by double newline" → Parses into array
4. "Convert text to speech" → ElevenLabs TTS for each part

**What we send:**
```typescript
{
  webhookResponse: ["Opening hook...", "Living areas...", "Private spaces...", "Outdoor...", "Closing CTA..."],
  // ... other fields
}
```

**Required change:**
Insert conditional before GPT step:
- If `webhookResponse` exists and has 5 items → Route directly to ElevenLabs (skip GPT)
- Otherwise → Use existing GPT flow (backwards compatible)

**Key decisions from STATE.md:**
- Section-based script (5 sections) instead of per-image scripts for cohesive narrative
- Min 50 chars per script section (for proper TTS timing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional script router node</name>
  <files>n8n workflow (via MCP tools)</files>
  <action>
Add a Code node after "Make Optimized Images Array from Nano-banana" that checks for wizard script:

```javascript
// Check if webhook provided pre-written script sections
const webhookData = $('Webhook').first().json.body[0];
const wizardScript = webhookData.webhookResponse;

// Wizard script exists and has all 5 sections?
const hasWizardScript = Array.isArray(wizardScript) &&
                        wizardScript.length >= 5 &&
                        wizardScript.every(s => typeof s === 'string' && s.length >= 50);

if (hasWizardScript) {
  // Route to TTS directly - skip GPT generation
  return wizardScript.map(text => ({ json: { text, source: 'wizard' } }));
} else {
  // Signal to use GPT flow
  return [{ json: { useGptFlow: true } }];
}
```

Use n8n MCP tools:
1. `n8n_get_workflow` to fetch current workflow
2. `n8n_update_partial_workflow` with `addNode` operation to insert the Code node
3. Position it between "Make Optimized Images Array from Nano-banana" and "Prepare Body for GPT"

Node name: "Check for wizard script"
  </action>
  <verify>
Use `n8n_get_workflow` to confirm:
- New "Check for wizard script" node exists
- Node is positioned after image processing
  </verify>
  <done>Code node added with conditional logic that checks webhookResponse array</done>
</task>

<task type="auto">
  <name>Task 2: Add IF node to route script flow</name>
  <files>n8n workflow (via MCP tools)</files>
  <action>
Add an IF node after "Check for wizard script" that branches:

**True branch (wizard script):** Connect directly to "Convert text to speech"
**False branch (GPT flow):** Connect to existing "Prepare Body for GPT To Analyze Images"

IF condition:
```
{{ $json.source }} equals "wizard"
```

Use `n8n_update_partial_workflow`:
1. `addNode` - IF node named "Use wizard script?"
2. `addConnection` - From "Check for wizard script" → "Use wizard script?"
3. `addConnection` - True output → "Convert text to speech"
4. `addConnection` - False output → "Prepare Body for GPT To Analyze Images"
5. `removeConnection` - Old connection from "Make Optimized Images Array" → "Prepare Body for GPT"

This preserves backwards compatibility: payloads without webhookResponse still get GPT-generated scripts.
  </action>
  <verify>
Use `n8n_get_workflow` mode='structure' to verify:
- IF node "Use wizard script?" exists
- Two output paths: wizard → TTS, GPT → existing flow
- Original GPT flow still intact for fallback
  </verify>
  <done>IF node routes wizard script directly to TTS, GPT flow preserved as fallback</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Script routing logic in n8n workflow - wizard script bypasses GPT generation</what-built>
  <how-to-verify>
    1. Open n8n workflow editor: https://edgeaimedia.app.n8n.cloud
    2. Find the "Youtube Video" workflow
    3. Verify new nodes exist:
       - "Check for wizard script" (Code node)
       - "Use wizard script?" (IF node)
    4. Trace the two paths:
       - WITH webhookResponse → Should go directly to "Convert text to speech"
       - WITHOUT webhookResponse → Should go to "Prepare Body for GPT"
    5. Optionally run a test execution with webhookResponse to verify the wizard path works
  </how-to-verify>
  <resume-signal>Type "approved" if both paths are wired correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] "Check for wizard script" Code node exists in workflow
- [ ] "Use wizard script?" IF node exists with two output paths
- [ ] Wizard path: webhookResponse → TTS (skip GPT)
- [ ] Fallback path: no webhookResponse → GPT → TTS (original flow)
- [ ] Human verified the workflow structure in n8n UI
</verification>

<success_criteria>
- n8n workflow has conditional script routing
- Wizard-provided script sections (webhookResponse) bypass GPT generation
- Payloads without webhookResponse fall back to GPT generation (backwards compatible)
- Workflow structure verified in n8n UI
</success_criteria>

<output>
After completion, create `.planning/phases/03-n8n-integration/03-04-SUMMARY.md`:

# Phase 03 Plan 04: Script Integration Summary

**[One-liner: what shipped]**

## Accomplishments
- Added conditional script routing to n8n workflow
- Wizard script sections now used directly for TTS
- Backwards compatible with GPT fallback

## Files Created/Modified
- n8n Youtube Video workflow (hjG60LIO86i5vxX3): Added nodes for script routing

## Workflow Changes
- New "Check for wizard script" Code node
- New "Use wizard script?" IF node
- Two paths: wizard → TTS (direct), fallback → GPT → TTS

## Decisions Made
[Any decisions during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 03-05-PLAN.md (Beat-synced lull transitions)
</output>
