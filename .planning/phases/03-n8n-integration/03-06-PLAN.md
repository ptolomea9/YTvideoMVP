---
phase: 03-n8n-integration
plan: 06
type: execute
---

<objective>
Add branded closing card (5-second scene) to video composition.

Purpose: Every video needs agent branding for social media distribution. The closing card displays agent contact info and CTA, making the video shareable and professional.
Output: Modified n8n workflow that appends a 5-second branded closing card to every video.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-n8n-integration/03-CONTEXT.md
@.planning/phases/03-n8n-integration/03-RESEARCH.md
@.planning/phases/03-n8n-integration/03-05-SUMMARY.md

**Target Workflow:** `Qo2sirL0cDI2fVNQMJ5Eq` (Shawheen Youtube Video)

**Video Pipeline Stage for Modification:**
```
"get video metadata to add music"
  → "Prepare body for jsontovideo to render video" (creates music timeline + text overlays)
  → "Call jsontovideo to render"
  → ... polling ...
  → "Format variables for final editing1"
  → "json2video - Edit video1" (template adds captions)
```

The closing card should be added in "Prepare body for jsontovideo to render video" as a second scene. This way:
- The main video scene has property footage + music + text overlays
- The closing card scene (5 seconds) has agent branding
- Both render together in one json2video call
- The template step AFTER this adds captions (only to main video, not closing card - correct behavior)

**Webhook Payload Agent Fields (from wizard):**
- `agentName` - mandatory
- `agentPhone` - mandatory
- `agentEmail` - mandatory
- `social_handles` - mandatory (already used)
- `agentCta` - mandatory (e.g., "Schedule a Tour")
- `logoUrl` - optional
- `headshotUrl` - optional

**Key Decisions from 03-CONTEXT.md:**
- Branded videos only (unbranded MLS deferred)
- 5-second closing card duration
- Dark luxury background (#1a1a1a)
- Bodoni Moda for agent name, Inter for contact info
- Logo and headshot conditional (only if provided)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update "Prepare body for jsontovideo to render video" to include closing card</name>
  <files>n8n workflow Qo2sirL0cDI2fVNQMJ5Eq</files>
  <action>
Modify the existing "Prepare body for jsontovideo to render video" Code node to add a closing card as a second scene.

Current node creates a payload with one scene containing the video + music timeline + text overlays.

Update the code to:
1. Keep ALL existing logic (music timeline, text elements)
2. Read agent data from Webhook: agentName, agentPhone, agentEmail, social_handles, agentCta, logoUrl, headshotUrl
3. Build a closing card scene with branding elements
4. Add closing card as a second scene in the `scenes` array

Replace the existing jsCode with:

```javascript
const inputData = $input.first().json;
const videoUrl = inputData.videoUrl;
const musicUrl = inputData.musicUrl;
const durations = inputData.durations;
const starts = inputData.starts;
const videoDuration = inputData.videoDuration;

// Get property details from Webhook node
const webhook = $('Webhook').first().json.body[0];
const address = webhook.address || '';
const city = webhook.city || '';
const size = webhook.size || '';
const bedroomCount = webhook.bedroomCount || '';
const bathroomCount = webhook.bathroomCount || '';
const lotSize = webhook.lotSize || '';

// Agent data for closing card
const agentName = webhook.agentName || '';
const agentPhone = webhook.agentPhone || '';
const agentEmail = webhook.agentEmail || '';
const socialHandles = webhook.social_handles || '';
const agentCta = webhook.agentCta || 'Contact Me Today';
const logoUrl = webhook.logoUrl || '';
const headshotUrl = webhook.headshotUrl || '';

// Music volume settings
const MUSIC_HIGH = 1.0;
const MUSIC_LOW = 0.2;
const FADE_TIME = 0.3;

let musicTimeline = [];
let textElements = [];
let currentTime = 0;
let musicOffset = 0;
let textIndex = 0;

// Property details to display on high music segments
const propertyDetails = [
  `${address}, ${city}`,
  `${size} sq ft`,
  `${bedroomCount} Bed | ${bathroomCount} Bath`
];

// Add lot size if available
if (lotSize) {
  propertyDetails.push(`Lot: ${lotSize} sq ft`);
}

// Build music timeline and text overlays (existing logic)
for (let i = 0; i < starts.length; i++) {
  const voiceStart = starts[i];
  const voiceDuration = durations[i];
  const voiceEnd = voiceStart + voiceDuration;

  // HIGH volume before voice
  if (voiceStart > currentTime) {
    const gapDuration = voiceStart - currentTime;

    // Add high volume music
    musicTimeline.push({
      type: "audio",
      src: musicUrl,
      start: currentTime,
      seek: musicOffset,
      duration: gapDuration,
      volume: MUSIC_HIGH,
      "fade-out": FADE_TIME
    });

    // Add text overlay during high music (if we have text to show)
    if (textIndex < propertyDetails.length && gapDuration > 1) {
      textElements.push({
        type: "text",
        text: propertyDetails[textIndex],
        style: "001",
        start: currentTime,
        duration: gapDuration,
        position: "custom",
        x: 0,
        y: 100,
        width: 1080,
        settings: {
          "font-family": "Bodoni Moda",
          "font-weight": "400",
          "font-size": "64px",
          "color": "#FFFFFF",
          "text-align": "center",
          "vertical-align": "top",
          "background-color": "rgba(0, 0, 0, 0.2)",
          "padding": "25px 50px",
          "border-radius": "20px",
          "text-shadow": "2px 2px 8px rgba(0, 0, 0, 0.8)"
        }
      });
      textIndex++;
    }

    musicOffset += gapDuration;
  }

  // LOW volume during voice
  musicTimeline.push({
    type: "audio",
    src: musicUrl,
    start: voiceStart,
    seek: musicOffset,
    duration: voiceDuration,
    volume: MUSIC_LOW,
    "fade-in": FADE_TIME,
    "fade-out": FADE_TIME
  });

  musicOffset += voiceDuration;
  currentTime = voiceEnd;
}

// HIGH volume after last voice (only if there's time left)
if (currentTime < videoDuration) {
  const remainingDuration = videoDuration - currentTime;

  // Add high volume music
  musicTimeline.push({
    type: "audio",
    src: musicUrl,
    start: currentTime,
    seek: musicOffset,
    duration: remainingDuration,
    volume: MUSIC_HIGH,
    "fade-in": FADE_TIME,
    "fade-out": 0.5
  });

  // Add text overlay during final high music (if we have text left to show)
  if (textIndex < propertyDetails.length && remainingDuration > 1) {
    textElements.push({
      type: "text",
      text: propertyDetails[textIndex],
      style: "001",
      start: currentTime,
      duration: remainingDuration,
      position: "custom",
      x: 0,
      y: 100,
      width: 1080,
      settings: {
        "font-family": "Bodoni Moda",
        "font-weight": "400",
        "font-size": "64px",
        "color": "#FFFFFF",
        "text-align": "center",
        "vertical-align": "top",
        "background-color": "rgba(0, 0, 0, 0.2)",
        "padding": "25px 50px",
        "border-radius": "20px",
        "text-shadow": "2px 2px 8px rgba(0, 0, 0, 0.8)"
      }
    });
  }
}

// =====================
// BUILD CLOSING CARD SCENE
// =====================
const closingCardElements = [];

// Optional logo at top (centered)
if (logoUrl) {
  closingCardElements.push({
    type: "image",
    src: logoUrl,
    position: "custom",
    x: 465,
    y: 300,
    width: 150,
    height: -1,
    "fade-in": 0.5
  });
}

// Optional headshot below logo (centered)
if (headshotUrl) {
  closingCardElements.push({
    type: "image",
    src: headshotUrl,
    position: "custom",
    x: 440,
    y: logoUrl ? 500 : 400,
    width: 200,
    height: 200,
    "fade-in": 0.5
  });
}

// Calculate Y positions based on what's shown
const hasVisual = logoUrl || headshotUrl;
const baseY = hasVisual ? 800 : 700;

// Agent name - main headline
closingCardElements.push({
  type: "text",
  text: agentName,
  position: "custom",
  x: 0,
  y: baseY,
  width: 1080,
  settings: {
    "font-family": "Bodoni Moda",
    "font-size": "56px",
    "font-weight": "700",
    "font-color": "#FFFFFF",
    "text-align": "center"
  },
  "fade-in": 0.3
});

// CTA text - gold accent
closingCardElements.push({
  type: "text",
  text: agentCta,
  position: "custom",
  x: 0,
  y: baseY + 100,
  width: 1080,
  settings: {
    "font-family": "Inter",
    "font-size": "36px",
    "font-weight": "600",
    "font-color": "#D4AF37",
    "text-align": "center"
  },
  "fade-in": 0.4
});

// Contact info - phone | email
const contactLine = [agentPhone, agentEmail].filter(Boolean).join(' | ');
if (contactLine) {
  closingCardElements.push({
    type: "text",
    text: contactLine,
    position: "custom",
    x: 0,
    y: baseY + 200,
    width: 1080,
    settings: {
      "font-family": "Inter",
      "font-size": "24px",
      "font-weight": "400",
      "font-color": "#CCCCCC",
      "text-align": "center"
    },
    "fade-in": 0.5
  });
}

// Social handles
if (socialHandles) {
  closingCardElements.push({
    type: "text",
    text: socialHandles,
    position: "custom",
    x: 0,
    y: baseY + 280,
    width: 1080,
    settings: {
      "font-family": "Inter",
      "font-size": "20px",
      "font-weight": "400",
      "font-color": "#AAAAAA",
      "text-align": "center"
    },
    "fade-in": 0.6
  });
}

// Build the closing card scene
const closingCardScene = {
  "background-color": "#1a1a1a",
  duration: 5,
  elements: closingCardElements
};

// =====================
// CREATE FINAL PAYLOAD
// =====================
const payload = {
  width: 1080,
  height: 1920,
  quality: "high",
  resolution: "custom",
  scenes: [
    {
      // Scene 1: Main video with music and text overlays
      elements: [
        {
          type: "video",
          src: videoUrl,
          volume: 1
        },
        ...musicTimeline,
        ...textElements
      ]
    },
    // Scene 2: Closing card with agent branding
    closingCardScene
  ]
};

return { json: payload };
```

Use n8n MCP `n8n_update_partial_workflow` with operation type `updateNode` to update the node's parameters.jsCode field.
  </action>
  <verify>
`n8n_get_workflow` with mode=full and check "Prepare body for jsontovideo to render video" node has:
- scenes array with 2 scenes (not 1)
- Second scene has closingCardScene with agent branding elements
- First scene still has video, musicTimeline, textElements
  </verify>
  <done>"Prepare body for jsontovideo to render video" now creates a 2-scene composition: main video + closing card</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Closing card scene added to video composition in "Prepare body for jsontovideo to render video" node</what-built>
  <how-to-verify>
    1. Open n8n workflow: Shawheen Youtube Video
    2. Find "Prepare body for jsontovideo to render video" Code node
    3. Verify the JavaScript code now:
       - Reads agent data from webhook (agentName, agentPhone, etc.)
       - Builds closingCardElements array with text elements
       - Creates closingCardScene with 5-second duration and #1a1a1a background
       - Returns payload.scenes with TWO scenes (main video + closing card)
    4. Check the closing card scene has:
       - Agent name in Bodoni Moda 56px white
       - CTA in Inter 36px gold (#D4AF37)
       - Contact info in Inter 24px gray
       - Social handles in Inter 20px gray
       - Conditional logo/headshot images
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] "Prepare body for jsontovideo to render video" node updated
- [ ] Payload has scenes array with 2 scenes
- [ ] Scene 2 is the closing card with agent branding
- [ ] Webhook agent data is used (agentName, agentPhone, agentEmail, socialHandles, agentCta)
- [ ] Logo and headshot are conditional
- [ ] Human verified in n8n UI
</verification>

<success_criteria>
- Single Code node updated (no new nodes needed)
- Closing card scene appended to video composition
- Agent branding elements correctly positioned
- Human verified workflow looks correct
</success_criteria>

<output>
After completion, create `.planning/phases/03-n8n-integration/03-06-SUMMARY.md`:

# Phase 03 Plan 06: json2video Closing Card Summary

**[One-liner describing what shipped]**

## Accomplishments
- Added 5-second closing card as second scene in video composition
- Agent branding: name, CTA, contact info, social handles
- Conditional logo and headshot (only shown if provided in webhook)
- Single-render approach (no additional render cycle needed)

## Files Created/Modified
- n8n workflow `Qo2sirL0cDI2fVNQMJ5Eq` - updated "Prepare body for jsontovideo to render video"

## Decisions Made
- Added closing card in existing Code node (not as separate node)
- Closing card renders with main video (template captions only apply to Scene 1)

## Issues Encountered
- [Any issues and resolutions]

## Next Phase Readiness
- Ready for 03-07-PLAN.md (Completion webhook and status updates)
</output>
