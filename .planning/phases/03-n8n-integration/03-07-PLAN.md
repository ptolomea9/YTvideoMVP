---
phase: 03-n8n-integration
plan: 07
type: execute
---

<objective>
Close the video generation loop with n8n completion callback, database updates, and realtime user notifications.

Purpose: When n8n finishes video generation, the app must update the database, notify the user via toast, and show the video in the dashboard. This is the final plan of Phase 3 - completes the n8n integration pipeline.

Output: Working completion webhook, realtime status updates, and toast notifications for video completion/failure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-n8n-integration/03-07-CONTEXT.md
@.planning/phases/03-n8n-integration/03-06-SUMMARY.md

# Source files to reference
@src/app/api/listings/create/route.ts (webhook trigger pattern)
@src/lib/n8n/client.ts (n8n integration patterns)
@src/lib/supabase/server.ts (server client pattern)
@src/app/layout.tsx (Toaster already configured)
@supabase/migrations/001_initial_schema.sql (videos table schema)

# Key context from 03-07-CONTEXT.md
- Reliability is top priority (videos never lost)
- Toast for both success and failure
- Failure toast shows specific error (e.g., "Voice generation failed")
- Database is source of truth

# Database schema (videos table)
- status: 'pending' | 'processing' | 'completed' | 'failed' | etc.
- branded_url: TEXT
- unbranded_url: TEXT
- thumbnail_url: TEXT
- error_message: TEXT
- n8n_execution_id: TEXT

# Current n8n workflow state
- HTTP Request node at end calls `https://backend.edgeairealty.com/api/video/download` (old endpoint)
- Sends: email, videoUrl, title, executionId, videoType
- Needs to be updated to call our new Next.js endpoint with video_id
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create completion webhook API endpoint</name>
  <files>src/app/api/videos/complete/route.ts</files>
  <action>
Create POST /api/videos/complete endpoint that receives n8n callback.

Expected payload from n8n:
- video_id: string (video UUID from initial trigger)
- video_url: string (final rendered video URL)
- thumbnail_url?: string (optional - generate from video if not provided)
- status: 'completed' | 'failed'
- error_message?: string (required if status is 'failed')
- execution_id: string (for audit trail)

Implementation:
1. Parse request body and validate required fields
2. Use service role client (createServiceRoleClient from @/lib/supabase/service) to bypass RLS - this is a server-to-server callback
3. If service role client doesn't exist, create it at src/lib/supabase/service.ts following existing server.ts pattern but using SUPABASE_SERVICE_ROLE_KEY
4. Update videos table:
   - status: from payload ('completed' or 'failed')
   - branded_url: video_url (for now - unbranded deferred per 03-CONTEXT.md)
   - thumbnail_url: from payload or null
   - error_message: from payload if failed
   - n8n_execution_id: from payload (update if different)
5. Return { success: true, videoId } or appropriate error

Security: Validate request comes from n8n via shared secret in Authorization header (N8N_WEBHOOK_SECRET env var). Return 401 if invalid. This prevents external actors from marking videos complete.

Error handling:
- Return 400 for missing required fields
- Return 401 for invalid/missing auth
- Return 404 if video_id not found
- Return 500 for database errors
  </action>
  <verify>
curl -X POST http://localhost:3000/api/videos/complete \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test-secret" \
  -d '{"video_id":"test-uuid","video_url":"https://example.com/video.mp4","status":"completed","execution_id":"exec-123"}' \
returns 401 (invalid secret) or 404 (video not found) as expected
  </verify>
  <done>
- API endpoint exists at /api/videos/complete
- Service role client created and working
- Validates Authorization header against N8N_WEBHOOK_SECRET
- Updates video record with status, URL, thumbnail, error_message
- Returns appropriate HTTP codes for all cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Update n8n workflow callback to new endpoint</name>
  <files>n8n workflow Qo2sirL0cDI2fVNQMJ5Eq (HTTP Request node)</files>
  <action>
Update the "HTTP Request" node (id: e2310a8b-b18b-49cd-b7cb-85ff7fc8ab3c) in the Youtube Video workflow to call our new completion endpoint.

Changes to HTTP Request node:
1. URL: Change from `https://backend.edgeairealty.com/api/video/download` to environment variable or hardcoded URL for our Next.js app (use N8N_APP_CALLBACK_URL or hardcode the Vercel/localhost URL)
2. Headers: Add Authorization header with Bearer token (N8N_WEBHOOK_SECRET)
3. Body parameters - update to match our expected payload:
   - video_id: Add this field - get from initial webhook payload: `={{ $('Webhook').first().json.body[0].videoId }}`
   - video_url: `={{ $json.video_url }}`
   - status: "completed" (hardcode - this path only runs on success)
   - execution_id: `={{ $execution.id }}`
   - thumbnail_url: Leave as null for now (json2video doesn't provide thumbnail)

Also update the initial webhook payload to include video_id:
- In src/lib/n8n/transform.ts, add videoId to the N8nTourVideoPayload type
- In src/app/api/listings/create/route.ts, include video.id in the n8n payload before triggering

Note: n8n workflow currently doesn't have error handling path to call our endpoint on failure. That's acceptable for MVP per 03-07-CONTEXT.md boundaries (focus on happy path).
  </action>
  <verify>
1. Use n8n MCP get_node to verify HTTP Request node has updated URL and Authorization header
2. Check transform.ts includes videoId in payload type
3. Check listings/create/route.ts includes video.id in webhook payload
  </verify>
  <done>
- HTTP Request node calls our /api/videos/complete endpoint
- Authorization header included with shared secret
- Payload includes video_id, video_url, status, execution_id
- Transform.ts and listings/create/route.ts updated to pass video_id
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Supabase Realtime subscription and toast notifications</name>
  <files>
src/hooks/useVideoStatusSubscription.ts
src/app/(protected)/layout.tsx
  </files>
  <action>
Create a custom hook that subscribes to video status changes and shows toast notifications.

1. Create useVideoStatusSubscription.ts hook:
   - Accept userId parameter
   - Subscribe to Supabase Realtime channel for videos table
   - Filter to user's videos: filter('user_id', 'eq', userId)
   - Listen for UPDATE events where status changes to 'completed' or 'failed'
   - On 'completed': Show success toast "Your video is ready!" with action to view
   - On 'failed': Show error toast with error_message from payload (e.g., "Video generation failed: Voice generation error")
   - Clean up subscription on unmount
   - Return { isSubscribed: boolean } for debugging

2. Add hook to protected layout:
   - Import useVideoStatusSubscription
   - Get current user from Supabase auth
   - Call hook with user.id
   - Hook handles all toast logic internally

3. Toast styling:
   - Use existing Sonner toast() from sonner package
   - Success: toast.success("Your video is ready!", { action: { label: "View", onClick: () => router.push('/dashboard') } })
   - Error: toast.error(`Video generation failed: ${error_message}`)

Important: Supabase Realtime requires database replication to be enabled for the videos table. If not already enabled, add migration 008_enable_realtime.sql with:
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE videos;
```
  </action>
  <verify>
1. Hook file exists with proper Supabase Realtime subscription
2. Protected layout imports and uses the hook
3. Build succeeds: npm run build
4. Manual test: Update video status directly in Supabase dashboard, verify toast appears
  </verify>
  <done>
- useVideoStatusSubscription hook created with Realtime subscription
- Hook integrated into protected layout
- Success toast shows on status='completed'
- Error toast shows on status='failed' with error message
- Realtime enabled for videos table (migration added if needed)
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /api/videos/complete endpoint responds correctly to valid/invalid requests
- [ ] Service role client exists and can update videos table
- [ ] n8n HTTP Request node configured with correct URL and auth header
- [ ] videoId flows from listings/create through n8n and back to completion webhook
- [ ] Realtime subscription hook created and integrated
- [ ] `npm run build` succeeds without errors
- [ ] Videos table has Realtime enabled
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Complete data flow: wizard submit → n8n trigger with videoId → n8n processing → completion callback → database update → realtime event → toast notification
- Phase 3 (n8n Integration) complete - video generation pipeline fully operational
</success_criteria>

<output>
After completion, create `.planning/phases/03-n8n-integration/03-07-SUMMARY.md`:

# Phase 03 Plan 07: Completion Webhook and Status Updates Summary

**[One-liner describing what shipped]**

## Accomplishments

- Completion webhook API endpoint
- n8n workflow callback configuration
- Realtime subscription and toast notifications

## Files Created/Modified

- `src/app/api/videos/complete/route.ts` - Completion webhook
- `src/lib/supabase/service.ts` - Service role client (if created)
- `src/lib/n8n/transform.ts` - videoId in payload type
- `src/app/api/listings/create/route.ts` - videoId in webhook payload
- `src/hooks/useVideoStatusSubscription.ts` - Realtime hook
- `src/app/(protected)/layout.tsx` - Hook integration
- `supabase/migrations/008_enable_realtime.sql` - Realtime enablement (if needed)
- n8n workflow HTTP Request node - Updated

## Decisions Made

[Document any decisions made during execution]

## Issues Encountered

[Document any issues and how they were resolved]

## Next Phase Readiness

Phase 3 complete. Ready for Phase 4: Dashboard (video gallery with 9:16 cards, hover autoplay, realtime progress states).
</output>
