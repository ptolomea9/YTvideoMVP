---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Implement Supabase Auth flow with login, signup, session management, and protected routes.

Purpose: Enable user authentication so agents can access their own data securely.
Output: Working auth flow with email/password signup, login, logout, and route protection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md (when exists)
@.planning/phases/01-foundation/01-02-SUMMARY.md (when exists)

**Auth requirements:**
- Email/password authentication (Supabase Auth)
- Session persistence via cookies (SSR-compatible)
- Protected routes redirect to login
- Post-login redirect to /dashboard

**Design constraints:**
- Dark luxury theme (from 01-01)
- shadcn/ui components for forms
- Simple, elegant auth pages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth middleware and callback handler</name>
  <files>src/middleware.ts, src/app/auth/callback/route.ts</files>
  <action>
1. Create src/middleware.ts for session refresh:
   - Use createServerClient from @supabase/ssr
   - Refresh session on every request
   - Protect routes: /dashboard, /create, /settings require auth
   - Redirect unauthenticated users to /login
   - Allow public access to: /, /login, /signup, /auth/callback

2. Create src/app/auth/callback/route.ts:
   - Handle OAuth callback and email confirmation
   - Exchange code for session
   - Redirect to /dashboard on success

Use Next.js 15 App Router patterns. Do NOT use the old pages router approach.
  </action>
  <verify>Middleware file created, callback route exists</verify>
  <done>Auth middleware protecting routes, callback handler ready</done>
</task>

<task type="auto">
  <name>Task 2: Create login and signup pages</name>
  <files>src/app/(auth)/login/page.tsx, src/app/(auth)/signup/page.tsx, src/app/(auth)/layout.tsx</files>
  <action>
1. Create src/app/(auth)/layout.tsx:
   - Centered card layout for auth forms
   - Dark background matching luxury theme
   - No nav header (clean auth experience)

2. Create src/app/(auth)/login/page.tsx:
   - Form with email and password inputs (use shadcn/ui Input)
   - Submit button (use shadcn/ui Button)
   - Link to signup page
   - Error message display area
   - Use Server Action for form submission
   - Call supabase.auth.signInWithPassword()
   - Redirect to /dashboard on success
   - Display error on failure

3. Create src/app/(auth)/signup/page.tsx:
   - Form with email, password, confirm password
   - Validate passwords match client-side
   - Use Server Action for form submission
   - Call supabase.auth.signUp()
   - Show success message (check email for confirmation)
   - Link to login page

Style both pages with:
- Bodoni Moda heading ("Welcome back" / "Create account")
- Gold accent on primary button
- Subtle card border (#2A2A2A)
- Proper form spacing
  </action>
  <verify>Both pages render without errors, forms are styled correctly</verify>
  <done>Login and signup pages created with luxury styling</done>
</task>

<task type="auto">
  <name>Task 3: Create protected dashboard shell and logout</name>
  <files>src/app/(protected)/layout.tsx, src/app/(protected)/dashboard/page.tsx, src/components/nav/user-nav.tsx</files>
  <action>
1. Create src/app/(protected)/layout.tsx:
   - Shared layout for authenticated pages
   - Fetch user session in Server Component
   - Pass user to client components via context or props
   - Include header with user nav

2. Create src/components/nav/user-nav.tsx:
   - Display user email
   - Dropdown with: Settings link, Logout button
   - Logout calls supabase.auth.signOut() and redirects to /login
   - Use shadcn/ui DropdownMenu (add component: `npx shadcn@latest add dropdown-menu`)

3. Create src/app/(protected)/dashboard/page.tsx:
   - Simple placeholder: "Welcome, [user email]"
   - Text: "Your videos will appear here"
   - This is just a shell - actual dashboard built in Phase 4

4. Add shadcn/ui components needed:
   - `npx shadcn@latest add dropdown-menu`
   - `npx shadcn@latest add avatar`

Ensure logout works by clearing session and redirecting.
  </action>
  <verify>Can log in, see dashboard with email, log out successfully</verify>
  <done>Protected dashboard shell and user navigation working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auth flow: signup, email confirmation, login, protected routes, logout</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/dashboard (should redirect to /login)
    3. Click "Create account" link to go to signup
    4. Enter email, password, confirm password
    5. Check email for confirmation link (Supabase sends it)
    6. Click confirmation link (redirects to app)
    7. Log in with credentials
    8. Verify dashboard shows with your email
    9. Click user dropdown and logout
    10. Verify redirected to login page
    11. Try visiting /dashboard again - should redirect to login
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Middleware protects /dashboard, /create, /settings routes
- [ ] Login page works with valid credentials
- [ ] Signup page creates account (check Supabase dashboard)
- [ ] Logout clears session
- [ ] Protected routes redirect unauthenticated users
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified auth flow works end-to-end
- Phase 1 Foundation complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`

This completes Phase 1: Foundation. Ready for Phase 2: Create Wizard.
</output>
