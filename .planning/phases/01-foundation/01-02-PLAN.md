---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Create Supabase database schema with profiles, listings, videos, and credits tables, plus row-level security policies.

Purpose: Establish the data foundation for multi-tenant SaaS with proper agent isolation and future agency team access patterns.
Output: Complete database schema in Supabase with RLS policies enforcing data isolation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md (when exists)

**Database requirements:**
- profiles: user metadata, agency branding
- listings: property data for video generation
- videos: generated video records with status tracking
- credits: subscription-based usage tracking

**Multi-tenancy:**
- Agent isolation: users see only their own data
- Agency pattern: future support for team access (deferred past MVP)

**Constraints:**
- Supabase Postgres with RLS
- Credit system gates API usage (Kling, ElevenLabs, json2video costs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase client and configure environment</name>
  <files>package.json, .env.local, src/lib/supabase/client.ts, src/lib/supabase/server.ts</files>
  <action>
1. Install Supabase packages:
   `npm install @supabase/supabase-js @supabase/ssr`

2. Create .env.local with placeholders (user will fill in after Supabase project creation):
   ```
   NEXT_PUBLIC_SUPABASE_URL=your-project-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   ```

3. Create src/lib/supabase/client.ts for browser-side Supabase client:
   - Use createBrowserClient from @supabase/ssr
   - Export typed client function

4. Create src/lib/supabase/server.ts for server-side Supabase client:
   - Use createServerClient from @supabase/ssr
   - Handle cookies for auth session
   - Export typed client function for use in Server Components and Route Handlers

Do NOT create middleware yet - that's handled in the auth plan.
  </action>
  <verify>npm run build succeeds (will warn about missing env vars, that's expected)</verify>
  <done>Supabase client libraries installed, client/server helpers created</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema SQL migration</name>
  <files>supabase/migrations/001_initial_schema.sql</files>
  <action>
Create SQL migration file with complete schema. User will run this in Supabase SQL editor.

**profiles table:**
- id: uuid references auth.users primary key
- email: text not null
- full_name: text
- avatar_url: text (for agency headshot)
- agency_logo_url: text (for branded videos)
- agency_name: text
- subscription_tier: text default 'free' (free, starter, pro, agency)
- stripe_customer_id: text
- created_at: timestamptz default now()
- updated_at: timestamptz default now()

**listings table:**
- id: uuid primary key default gen_random_uuid()
- user_id: uuid references profiles not null
- address: text not null
- city: text
- state: text
- zip: text
- price: integer
- bedrooms: integer
- bathrooms: numeric(3,1)
- sqft: integer
- property_type: text (single_family, condo, townhouse, etc.)
- description: text
- neighborhood_pois: jsonb (points of interest from API)
- created_at: timestamptz default now()
- updated_at: timestamptz default now()

**videos table:**
- id: uuid primary key default gen_random_uuid()
- listing_id: uuid references listings not null
- user_id: uuid references profiles not null
- status: text default 'pending' (pending, processing, sorting_images, generating_motion, generating_audio, rendering, completed, failed)
- script_sections: jsonb (5 editable sections)
- voice_id: text (ElevenLabs voice selection)
- music_enabled: boolean default true
- branded_url: text (S3 URL when complete)
- unbranded_url: text (S3 URL when complete)
- thumbnail_url: text
- duration_seconds: integer
- error_message: text
- n8n_execution_id: text (for debugging)
- created_at: timestamptz default now()
- updated_at: timestamptz default now()

**credits table:**
- id: uuid primary key default gen_random_uuid()
- user_id: uuid references profiles not null
- amount: integer not null (positive = credit, negative = debit)
- reason: text not null (subscription_renewal, video_generation, overage_purchase)
- video_id: uuid references videos (null for subscription credits)
- stripe_payment_id: text
- created_at: timestamptz default now()

**Indexes:**
- listings(user_id)
- videos(user_id)
- videos(listing_id)
- videos(status)
- credits(user_id)

Include updated_at trigger function for profiles, listings, videos.
  </action>
  <verify>SQL file is valid (no syntax errors when linted)</verify>
  <done>Complete schema SQL ready for Supabase migration</done>
</task>

<task type="auto">
  <name>Task 3: Create RLS policies SQL</name>
  <files>supabase/migrations/002_rls_policies.sql</files>
  <action>
Create SQL migration file with row-level security policies.

**Enable RLS on all tables:**
```sql
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE listings ENABLE ROW LEVEL SECURITY;
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;
ALTER TABLE credits ENABLE ROW LEVEL SECURITY;
```

**profiles policies:**
- SELECT: users can read their own profile (auth.uid() = id)
- UPDATE: users can update their own profile (auth.uid() = id)
- INSERT: handled by trigger on auth.users creation

**listings policies:**
- SELECT: users can read their own listings (auth.uid() = user_id)
- INSERT: users can create listings for themselves (auth.uid() = user_id)
- UPDATE: users can update their own listings (auth.uid() = user_id)
- DELETE: users can delete their own listings (auth.uid() = user_id)

**videos policies:**
- SELECT: users can read their own videos (auth.uid() = user_id)
- INSERT: users can create videos for themselves (auth.uid() = user_id)
- UPDATE: users can update their own videos (auth.uid() = user_id)
- No DELETE policy - videos are permanent records

**credits policies:**
- SELECT: users can read their own credit history (auth.uid() = user_id)
- INSERT: service role only (credits added by server/webhooks)
- No UPDATE/DELETE - credit ledger is append-only

**Profile creation trigger:**
Create trigger that auto-creates profile row when user signs up via auth.users.

Note: Agency team access patterns (allowing team members to see agency data) are OUT OF SCOPE for MVP. Current RLS is strictly user = their own data.
  </action>
  <verify>SQL file is valid, RLS policies cover all CRUD operations appropriately</verify>
  <done>RLS policies SQL ready, enforcing user isolation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Supabase client libraries installed
- [ ] Client and server Supabase helpers created
- [ ] Schema SQL migration file created with all 4 tables
- [ ] RLS policies SQL migration file created
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Schema covers profiles, listings, videos, credits
- RLS policies enforce user isolation
- SQL ready for manual execution in Supabase dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`

Note: User must manually:
1. Create Supabase project at supabase.com
2. Run the SQL migrations in the SQL editor
3. Copy project URL and anon key to .env.local
</output>
